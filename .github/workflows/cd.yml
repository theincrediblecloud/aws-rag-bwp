name: CD

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      AWS_REGION: us-east-1

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::471112701253:role/gh-actions-deploy
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS identity
        run: aws sts get-caller-identity

      - name: SAM build
        run: sam build --template-file infra/sam/template.yaml --debug

      - name: Deploy to DEV
        run: |
          set -e
          sam deploy \
            --no-confirm-changeset \
            --resolve-s3 \
            --capabilities CAPABILITY_IAM \
            --stack-name slack-rag-dev \
            --parameter-overrides \
              ArtifactsBucket=slack-rag-artifacts-73918652 \
              INDEX_PREFIX=rag/index \
              USE_S3_INDEX=true

      - name: Check DEV stack status
        run: aws cloudformation describe-stacks --stack-name slack-rag-dev

      - name: DEV smoke test (with retry)
        run: |
          API=$(aws cloudformation describe-stacks --stack-name slack-rag-dev \
            --query "Stacks[0].Outputs[?OutputKey=='ApiUrl'].OutputValue" --output text)
          echo "API endpoint: $API"

          for i in {1..5}; do
            echo "Attempt $i: checking /health"
            if curl -sf "$API/health"; then
              echo "Health check passed"
              break
            fi
            echo "Health check failed, retrying in 10s..."
            sleep 10
          done

          echo "Checking /chat endpoint"
          curl -sf -X POST "$API/chat" -H "Content-Type: application/json" \
            -d '{"user_msg":"__ping__ retrieval only"}'

      - name: Manual approval before PROD
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: venkatamarella
          minimum-approvals: 1

      - name: Deploy to PROD
        run: |
          set -e
          sam deploy \
            --no-confirm-changeset \
            --resolve-s3 \
            --capabilities CAPABILITY_IAM \
            --stack-name slack-rag-prod-v2 \
            --parameter-overrides \
              ArtifactsBucket=slack-rag-artifacts-73918652 \
              INDEX_PREFIX=rag/index \
              USE_S3_INDEX=true

      - name: Check PROD stack status
        run: aws cloudformation describe-stacks --stack-name slack-rag-prod-v2
