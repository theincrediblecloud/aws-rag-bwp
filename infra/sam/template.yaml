AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: RAG FastAPI + Slack (no layers)

Parameters:
  ArtifactsBucket:               { Type: String }
  ModelName:                     { Type: String, Default: sentence-transformers/all-MiniLM-L6-v2 }
  IndexPrefix:                   { Type: String, Default: rag/index }
  SlackSigningSecretArn:         { Type: String }
  SlackBotTokenArn:              { Type: String }
  RagApiUrl:                     { Type: String }

Globals:
  Function:
    Runtime: python3.11
    Architectures: [arm64]  # Use ARM architecture for better performance/cost
    Timeout: 30
    MemorySize: 2048
    Environment:
      Variables:
        APP_ENV: prod
        ARTIFACTS_BUCKET: !Ref ArtifactsBucket
        MODEL_NAME: !Ref ModelName
        INDEX_PREFIX: !Ref IndexPrefix
        EMBEDDER_PROVIDER: bedrock
        # AWS_REGION: !Ref AWS::Region
        BEDROCK_REGION: !Ref AWS::Region
        SLACK_SIGNING_SECRET_ARN: !Ref SlackSigningSecretArn
        SLACK_BOT_TOKEN_ARN: !Ref SlackBotTokenArn

Resources:
  # Build a pure NumPy layer for arm64 Py3.11
  NumpyLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: numpy-1264-arm64
      ContentUri: ../../infra/layers/numpy   # <-- path on disk (see section B)
      CompatibleRuntimes: [python3.11]
      CompatibleArchitectures: [arm64]
      RetentionPolicy: Delete
    Metadata:
      BuildMethod: python3.11
      BuildArchitecture: arm64
      BuildProperties:
        Commands:
          # put site-packages under /opt/python so Lambda can import it
          - pip install -r requirements.txt -t "$LAMBDA_TASK_ROOT/python"

  HttpApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      StageName: Prod
      CorsConfiguration:
        AllowMethods: ["GET", "POST", "OPTIONS"]
        AllowHeaders: ["*"]
        AllowOrigins: ["*"]

  RAGApi:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../../src            # <- your repo's src/
      Handler: rag.api.app.handler
      Layers:
        - !Ref NumpyLayer         # <---- add the layer
      Policies:
        - S3ReadPolicy: { BucketName: !Ref ArtifactsBucket }
        - AWSSecretsManagerGetSecretValuePolicy: { SecretArn: !Ref SlackSigningSecretArn }
        - AWSSecretsManagerGetSecretValuePolicy: { SecretArn: !Ref SlackBotTokenArn }
        - Statement:
            - Effect: Allow
              Action:
                - logs:CreateLogGroup
                - logs:CreateLogStream
                - logs:PutLogEvents
              Resource: arn:aws:logs:*:*:*
                      # âœ… Bedrock invoke permissions
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
                - bedrock:InvokeModelWithResponseStream
              Resource:
                # lock to Titan embed model in us-east-1
                - arn:aws:bedrock:us-east-1::foundation-model/amazon.titan-embed-text-v2*
      Events:
        AnyRoute:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /{proxy+}
            Method: ANY

  SlackEventsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../../src       # <- your repo's handlers/
      Handler: handlers.slack_events.handler
      Layers:
        - !Ref NumpyLayer         # <---- add the layer
      MemorySize: 256
      Timeout: 10
      Environment:
        Variables:
          RagApiUrl: !Ref RagApiUrl
          SLACK_SIGNING_SECRET_ARN: !Ref SlackSigningSecretArn
          SLACK_BOT_TOKEN_ARN: !Ref SlackBotTokenArn
      Policies:
        - AWSSecretsManagerGetSecretValuePolicy: { SecretArn: !Ref SlackSigningSecretArn }
        - AWSSecretsManagerGetSecretValuePolicy: { SecretArn: !Ref SlackBotTokenArn }
        - Statement:
            - Effect: Allow
              Action:
                - logs:CreateLogGroup
                - logs:CreateLogStream
                - logs:PutLogEvents
              Resource: arn:aws:logs:*:*:*
        - Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
                - bedrock:InvokeModelWithResponseStream
              Resource:
                # lock to Titan embed model in us-east-1
                - arn:aws:bedrock:us-east-1::foundation-model/amazon.titan-embed-text-v2*
      Events:
        SlackEventsRoute:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /slack/events
            Method: POST

Outputs:
  ApiBaseUrl:
    Value: !Sub "https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com/Prod"
  SlackEventsUrl:
    Value: !Sub "https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/slack/events"
  ChatApiUrl:
    Value: !Sub "https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/chat"
  RAGApiFunction:
    Value: !Ref RAGApi
  SlackEventsFunction:
    Value: !Ref SlackEventsFunction